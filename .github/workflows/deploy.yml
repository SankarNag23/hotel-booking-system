name: Deploy to Render and Monitor Status

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "Triggering deployment..."
          curl -X POST https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys \
            -H "Authorization: Bearer $RENDER_API_KEY"
          
      - name: Monitor Deployment Status
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "Starting deployment status monitoring..."
          while true; do
            STATUS=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" | \
              jq -r '.[0].status')
            
            if [ "$STATUS" = "live" ]; then
              echo "✅ Deployment successful!"
              exit 0
            elif [ "$STATUS" = "failed" ]; then
              echo "❌ Deployment failed!"
              exit 1
            else
              echo "⏳ Deployment in progress... Status: $STATUS"
              sleep 30
            fi
          done
